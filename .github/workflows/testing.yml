name: Android Testing

on:
  workflow_call:

jobs:
  instrumented_tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        api-level: [33, 34]

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: "google_apis"
          arch: "x86_64"
          profile: "default"
          emulator-boot-timeout: 900

      - name: Ensure system image is available
        run: sdkmanager --install "system-images;android-${{ matrix.api-level }};google_apis;x86_64"

      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n testAVD-${{ matrix.api-level }} \
          -k "system-images;android-${{ matrix.api-level }};google_apis;x86_64" || true

      - name: Verify AVD creation
        run: ls ~/.android/avd/testAVD-${{ matrix.api-level }}.avd || exit 1

      - name: Start emulator
        run: |
          nohup emulator -avd testAVD-${{ matrix.api-level }} -no-audio -no-window -no-snapshot > emulator-${{ matrix.api-level }}.log 2>&1 &
          adb wait-for-device

      - name: Run Instrumented Tests
        run: ./gradlew :simplenotify:connectedAndroidTest

      - name: Stop Emulator
        run: adb emu kill